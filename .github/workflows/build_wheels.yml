name: Build wheels

on:
  push:
    branches: [ master, dev ]
    tags:
      - "*"
  pull_request:
    branches: [ master ]
  release:
    types: [ published ]

jobs:
  config:
    name: Load configuration
    runs-on: ubuntu-latest
    outputs:
      build_commit: ${{ steps.config.outputs.build_commit }}
      scm_version: ${{ steps.config.outputs.scm_version }}
      upload_test_pypi: ${{ steps.config.outputs.upload_test_pypi }}
      upload_official_pypi: ${{ steps.config.outputs.upload_official_pypi }}
    steps:
      - name: Load and set configuration
        id: config
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            BUILD_COMMIT="${GITHUB_REF_NAME}"
            SCM_VERSION="${GITHUB_REF_NAME}"
            UPLOAD_TO_TEST_PYPI=0
            UPLOAD_TO_OFFI_PYPI=1
          elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            BUILD_COMMIT="${GITHUB_REF_NAME}"
            SCM_VERSION="${GITHUB_REF_NAME}"
            UPLOAD_TO_TEST_PYPI=0
            UPLOAD_TO_OFFI_PYPI=1
          elif [[ "${GITHUB_REF_NAME}" == "master" ]]; then
            BUILD_COMMIT="master"
            SCM_VERSION=""
            UPLOAD_TO_TEST_PYPI=1
            UPLOAD_TO_OFFI_PYPI=0
          else
            BUILD_COMMIT="${GITHUB_REF_NAME}"
            SCM_VERSION=""
            UPLOAD_TO_TEST_PYPI=0
            UPLOAD_TO_OFFI_PYPI=0
          fi

          echo "build_commit=${BUILD_COMMIT}" >> $GITHUB_OUTPUT
          echo "scm_version=${SCM_VERSION}" >> $GITHUB_OUTPUT
          echo "upload_test_pypi=${UPLOAD_TO_TEST_PYPI}" >> $GITHUB_OUTPUT
          echo "upload_official_pypi=${UPLOAD_TO_OFFI_PYPI}" >> $GITHUB_OUTPUT

          echo "Build commit: ${BUILD_COMMIT}"
          echo "SCM Pretend Version: ${SCM_VERSION}"
          echo "Upload to TestPyPI: ${UPLOAD_TO_TEST_PYPI}"
          echo "Upload to PyPI: ${UPLOAD_TO_OFFI_PYPI}"

  create_release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref_type == 'tag' }}
    permissions:
      contents: write
    steps:
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true

  upload_release_assets:
    name: Upload release assets
    needs: [build_wheels_linux, build_wheels_macos, build_wheels_windows, build_sdist]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref_type == 'tag' }}
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cibw-*
          path: dist
          merge-multiple: true

      - name: Display release artifacts
        run: |
          echo "Release artifacts:"
          ls -la dist/

      - name: Upload assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: dist/*

  build_wheels_linux:
    name: Build wheels (Linux)
    needs: config
    if: ${{ github.event_name == 'release' || github.event_name == 'pull_request' || (github.event_name == 'push' && (github.ref_name == 'master' || github.ref_type == 'tag')) }}
    uses: ./.github/workflows/build_wheels_linux.yml
    with:
      build_commit: ${{ needs.config.outputs.build_commit }}
      scm_version: ${{ needs.config.outputs.scm_version }}

  build_wheels_macos:
    name: Build wheels (macOS)
    needs: config
    if: ${{ github.event_name == 'release' || github.event_name == 'pull_request' || (github.event_name == 'push' && (github.ref_name == 'master' || github.ref_type == 'tag')) }}
    uses: ./.github/workflows/build_wheels_macos.yml
    with:
      build_commit: ${{ needs.config.outputs.build_commit }}
      scm_version: ${{ needs.config.outputs.scm_version }}

  build_wheels_windows:
    name: Build wheels (Windows)
    needs: config
    if: ${{ github.event_name == 'release' || github.event_name == 'pull_request' || (github.event_name == 'push' && (github.ref_name == 'master' || github.ref_type == 'tag')) }}
    uses: ./.github/workflows/build_wheels_windows.yml
    with:
      build_commit: ${{ needs.config.outputs.build_commit }}
      scm_version: ${{ needs.config.outputs.scm_version }}

  build_sdist:
    name: Build source distribution
    needs: config
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'release' || github.event_name == 'pull_request' || (github.event_name == 'push' && (github.ref_name == 'master' || github.ref_type == 'tag')) }}
    steps:
      - name: Checkout kvxopt source
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/checkout@v4
        with:
          repository: 'kvxopt/kvxopt'
          ref: ${{ needs.config.outputs.build_commit }}
          path: .
          fetch-depth: 0
          fetch-tags: true

      - name: Checkout kvxopt source (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Build sdist
        run: |
          pipx run build --sdist
          cp dist/* ../dist/ || mkdir -p ../dist && cp dist/* ../dist/
        env:
            SETUPTOOLS_SCM_PRETEND_VERSION: ${{ needs.config.outputs.scm_version }}

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-sdist
          path: dist/*.tar.gz

  upload_test_pypi:
    name: Upload to TestPyPI
    needs: [config, build_wheels_linux, build_wheels_macos, build_wheels_windows, build_sdist]
    runs-on: ubuntu-latest
    if: >
      always() &&
      (needs.build_wheels_linux.result == 'success') &&
      (needs.build_wheels_macos.result == 'success') &&
      (needs.build_wheels_windows.result == 'success') &&
      (needs.build_sdist.result == 'success') &&
      (needs.config.outputs.upload_test_pypi == '1')

    environment:
      name: testpypi
      url: https://test.pypi.org/p/kvxopt

    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cibw-*
          path: dist
          merge-multiple: true

      - name: Display upload info
        run: |
          echo "Uploading to TestPyPI:"
          echo "Build commit: ${{ needs.config.outputs.build_commit }}"
          echo "Files to upload:"
          ls -la dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          verbose: true
          skip-existing: true

  upload_pypi:
    name: Upload to PyPI
    needs: [config, build_wheels_linux, build_wheels_macos, build_wheels_windows, build_sdist]
    runs-on: ubuntu-latest
    if: >
      always() &&
      (needs.build_wheels_linux.result == 'success') &&
      (needs.build_wheels_macos.result == 'success') &&
      (needs.build_wheels_windows.result == 'success') &&
      (needs.build_sdist.result == 'success') &&
      (needs.config.outputs.upload_official_pypi == '1') &&
      (github.event_name == 'release' || (github.event_name == 'push' && github.ref_type == 'tag'))

    environment:
      name: pypi
      url: https://pypi.org/p/kvxopt

    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cibw-*
          path: dist
          merge-multiple: true

      - name: Display upload info
        run: |
          echo "Uploading to PyPI:"
          echo "Build commit: ${{ needs.config.outputs.build_commit }}"
          echo "Files to upload:"
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
